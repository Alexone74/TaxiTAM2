<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Quiz Esame al Ruolo Conducenti</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            font-size: 16px;
        }
        @media (max-width: 640px) {
            html {
                font-size: 14px;
            }
        }
        button {
            touch-action: manipulation;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const icons = lucide.createIcons({
            icons: {
                BookOpen: lucide.icons.BookOpen,
                Home: lucide.icons.Home,
                Award: lucide.icons.Award,
                ArrowRight: lucide.icons.ArrowRight,
                Play: lucide.icons.Play,
                RefreshCw: lucide.icons.RefreshCw,
                CheckCircle: lucide.icons.CheckCircle,
                XCircle: lucide.icons.XCircle,
                LogIn: lucide.icons.LogIn,
                Lock: lucide.icons.Lock,
                LogOut: lucide.icons.LogOut,
                ChevronDown: lucide.icons.ChevronDown,
                ChevronUp: lucide.icons.ChevronUp,
                Globe: lucide.icons.Globe,
                FileText: lucide.icons.FileText,
                Clock: lucide.icons.Clock,
                AlertTriangle: lucide.icons.AlertTriangle
            }
        });

        function Icon({ name, ...props }) {
            return <i data-lucide={name} {...props}></i>;
        }
        function QuizApp() {
            const [screen, setScreen] = useState('login');
            const [quizData, setQuizData] = useState(null);
            const [accessCodes, setAccessCodes] = useState(null);
            const [error, setError] = useState(null);
            const [selectedQuestions, setSelectedQuestions] = useState([]);
            const [currentQuestion, setCurrentQuestion] = useState(0);
            const [score, setScore] = useState(0);
            const [answerGiven, setAnswerGiven] = useState(false);
            const [wrongQuestions, setWrongQuestions] = useState([]);
            const [reviewMode, setReviewMode] = useState(false);
            const [selectedCategories, setSelectedCategories] = useState([]);
            const [selectedAnswer, setSelectedAnswer] = useState(null);
            const [accessCode, setAccessCode] = useState('');
            const [loginError, setLoginError] = useState('');
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [isLoading, setIsLoading] = useState(false);
            const [expandedCategories, setExpandedCategories] = useState([]);
            
            // Nuove variabili di stato per la modalità esame
            const [examMode, setExamMode] = useState(false);
            const [examQuestions, setExamQuestions] = useState([]);
            const [examResults, setExamResults] = useState(null);
            const [selectedLanguage, setSelectedLanguage] = useState('Inglese');
            const [examWrongAnswers, setExamWrongAnswers] = useState({});
            const [examTime, setExamTime] = useState(0);
            const [examTimerRunning, setExamTimerRunning] = useState(false);
            const timerRef = useRef(null);
            
            // Funzione per creare hash SHA-256
            const hashCode = (code) => {
                return CryptoJS.SHA256(code).toString();
            };
            
            // Verifica se un utente è già autenticato
            useEffect(() => {
                const savedAuth = localStorage.getItem('quiz_authenticated');
                if (savedAuth === 'true') {
                    setIsAuthenticated(true);
                    setScreen('home');
                }
            }, []);

            // Carica i dati del quiz
            useEffect(() => {
                if (isAuthenticated) {
                    fetch('quiz.json')
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Network response was not ok');
                            }
                            return response.json();
                        })
                        .then(data => {
                            setQuizData(data);
                            setError(null);
                        })
                        .catch(error => {
                            console.error('Error loading quiz:', error);
                            setError('Errore nel caricamento del quiz. Riprova più tardi.');
                        });
                }
            }, [isAuthenticated]);

            // Carica i codici di accesso
            useEffect(() => {
                fetch('access-codes.json')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {
                        setAccessCodes(data);
                    })
                    .catch(error => {
                        console.error('Error loading access codes:', error);
                        setLoginError('Errore nel caricamento dei codici di accesso. Riprova più tardi.');
                    });
            }, []);
            // Timer per la modalità esame
            useEffect(() => {
                if (examTimerRunning) {
                    timerRef.current = setInterval(() => {
                        setExamTime(prevTime => prevTime + 1);
                    }, 1000);
                } else if (timerRef.current) {
                    clearInterval(timerRef.current);
                }
                
                return () => {
                    if (timerRef.current) {
                        clearInterval(timerRef.current);
                    }
                };
            }, [examTimerRunning]);

            const formatTime = (timeInSeconds) => {
                const minutes = Math.floor(timeInSeconds / 60);
                const seconds = timeInSeconds % 60;
                return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            };

            const handleLogin = () => {
                if (!accessCodes) {
                    setLoginError('Errore nel caricamento dei codici di accesso. Riprova più tardi.');
                    return;
                }

                setIsLoading(true);
                
                // Calcoliamo l'hash del codice inserito
                const hashedInput = hashCode(accessCode);
                
                // Verifichiamo se l'hash corrisponde a uno dei codici salvati
                if (accessCodes.codes.includes(hashedInput)) {
                    setIsAuthenticated(true);
                    localStorage.setItem('quiz_authenticated', 'true');
                    setScreen('home');
                    setLoginError('');
                } else {
                    setLoginError('Codice di accesso non valido');
                }
                
                setIsLoading(false);
            };

            const handleLogout = () => {
                setIsAuthenticated(false);
                localStorage.removeItem('quiz_authenticated');
                setScreen('login');
                setAccessCode('');
            };

            const toggleCategory = (categoryName) => {
                setExpandedCategories(prev => 
                    prev.includes(categoryName) 
                        ? prev.filter(c => c !== categoryName) 
                        : [...prev, categoryName]
                );
            };
            const startQuiz = () => {
                if (selectedCategories.length === 0) {
                    alert('Seleziona almeno una categoria!');
                    return;
                }

                const filteredQuestions = quizData.domande
                    .filter(q => selectedCategories.includes(q.categoria))
                    .sort(() => Math.random() - 0.5);

                setSelectedQuestions(filteredQuestions);
                setCurrentQuestion(0);
                setScore(0);
                setWrongQuestions([]);
                setReviewMode(false);
                setScreen('quiz');
                setSelectedAnswer(null);
                setAnswerGiven(false);
                setExamMode(false);
            };

            // Nuova funzione per avviare la modalità esame
            const startExam = () => {
                if (!quizData) return;
                
                // Reset del timer dell'esame
                setExamTime(0);
                setExamTimerRunning(true);
                
                // Ottieni 4 domande casuali per ogni categoria principale
                const geografiaQuestions = getRandomQuestions(quizData.domande, 'Geografia', 4);
                const normativaQuestions = getRandomQuestions(quizData.domande, 'Normativa Statale e Regionale', 4);
                const regolamentoQuestions = getRandomQuestions(quizData.domande, 'Regolamento e Comportamento', 4);
                
                // Ottieni 4 domande della lingua selezionata
                const languageQuestions = getRandomQuestions(quizData.domande, selectedLanguage, 4);
                
                // Combina tutte le domande
                const allExamQuestions = [
                    ...geografiaQuestions, 
                    ...normativaQuestions, 
                    ...regolamentoQuestions, 
                    ...languageQuestions
                ];
                
                // Mescola casualmente le domande
                const shuffledQuestions = allExamQuestions.sort(() => Math.random() - 0.5);
                
                setExamQuestions(shuffledQuestions);
                setSelectedQuestions(shuffledQuestions);
                setCurrentQuestion(0);
                setScore(0);
                setWrongQuestions([]);
                setExamWrongAnswers({
                    'Geografia': 0,
                    'Normativa Statale e Regionale': 0,
                    'Regolamento e Comportamento': 0,
                    [selectedLanguage]: 0
                });
                setReviewMode(false);
                setScreen('quiz');
                setSelectedAnswer(null);
                setAnswerGiven(false);
                setExamMode(true);
                setExamResults(null);
            };

            // Funzione per ottenere domande casuali da una categoria
            const getRandomQuestions = (allQuestions, category, count) => {
                const categoryQuestions = allQuestions.filter(q => q.categoria === category);
                
                // Se non ci sono abbastanza domande, restituisci tutte quelle disponibili
                if (categoryQuestions.length <= count) {
                    return categoryQuestions;
                }
                
                // Altrimenti, seleziona count domande casuali
                const shuffled = [...categoryQuestions].sort(() => Math.random() - 0.5);
                return shuffled.slice(0, count);
            };
            const checkAnswer = (selectedIndex) => {
                if (answerGiven) return;

                setAnswerGiven(true);
                setSelectedAnswer(selectedIndex);
                const currentQ = selectedQuestions[currentQuestion];

                if (selectedIndex === currentQ.risposta_corretta) {
                    setScore(prev => prev + 1);
                } else {
                    if (!reviewMode) {
                        setWrongQuestions(prev => [...prev, currentQ]);
                    }
                    
                    // Aggiorna i conteggi per la modalità esame
                    if (examMode) {
                        setExamWrongAnswers(prev => ({
                            ...prev,
                            [currentQ.categoria]: prev[currentQ.categoria] + 1
                        }));
                    }
                }
            };

            const nextQuestion = () => {
                if (currentQuestion < selectedQuestions.length - 1) {
                    setCurrentQuestion(prev => prev + 1);
                    setAnswerGiven(false);
                    setSelectedAnswer(null);
                } else {
                    // Se siamo in modalità esame, ferma il timer e calcola i risultati
                    if (examMode) {
                        setExamTimerRunning(false);
                        const passed = checkExamPassed();
                        setExamResults({
                            passed,
                            totalErrors: selectedQuestions.length - score,
                            errorsByCategory: examWrongAnswers,
                            time: examTime
                        });
                    }
                    
                    setScreen('results');
                }
            };

            // Controlla se l'esame è superato (max 4 errori totali, max 2 per categoria)
            const checkExamPassed = () => {
                const totalErrors = selectedQuestions.length - score;
                if (totalErrors > 4) return false;
                
                // Controlla errori per categoria
                for (const category in examWrongAnswers) {
                    if (examWrongAnswers[category] > 2) return false;
                }
                
                return true;
            };

            const startReview = () => {
                setSelectedQuestions(wrongQuestions);
                setCurrentQuestion(0);
                setScore(0);
                setWrongQuestions([]);
                setReviewMode(true);
                setScreen('quiz');
                setAnswerGiven(false);
                setSelectedAnswer(null);
            };

            const handleCategoryClick = (category) => {
                setSelectedCategories(prev =>
                    prev.includes(category)
                        ? prev.filter(c => c !== category)
                        : [...prev, category]
                );
            };
            // Gestione del tasto Enter per il login
            const handleKeyPress = (e) => {
                if (e.key === 'Enter') {
                    handleLogin();
                }
            };

            // Schermata di login
            if (screen === 'login') {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-indigo-600 via-purple-600 to-pink-500 flex items-center justify-center p-4">
                        <div className="max-w-md w-full bg-white rounded-2xl shadow-2xl overflow-hidden">
                            <div className="bg-white/90 p-6 border-b border-gray-100 flex justify-center">
                                <img 
                                    src="logo.png"
                                    alt="TAM - Tassisti Artigiani Milanesi"
                                    className="h-20 md:h-28"
                                />
                            </div>
                            
                            <div className="p-6 space-y-6">
                                <div className="text-center space-y-2">
                                    <Icon name="Lock" className="mx-auto text-purple-600 w-12 h-12" />
                                    <h2 className="text-2xl font-bold text-gray-800">Accesso al Quiz</h2>
                                    <p className="text-gray-600">Inserisci il tuo codice di accesso</p>
                                </div>
                                
                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">
                                            Codice di accesso
                                        </label>
                                        <input
                                            type="text"
                                            value={accessCode}
                                            onChange={(e) => setAccessCode(e.target.value)}
                                            onKeyPress={handleKeyPress}
                                            placeholder="Inserisci il codice di 8 caratteri"
                                            className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-all"
                                            maxLength={15}
                                        />
                                    </div>
                                    
                                    {loginError && (
                                        <div className="text-red-500 text-sm font-medium">{loginError}</div>
                                    )}
                                    
                                    <button
                                        onClick={handleLogin}
                                        disabled={isLoading || accessCode.length < 3}
                                        className={`w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white p-4 rounded-xl 
                                                font-semibold transition-all duration-200 flex items-center justify-center gap-2
                                                ${(isLoading || accessCode.length < 3) ? 'opacity-70 cursor-not-allowed' : 'hover:opacity-90'}`}
                                    >
                                        {isLoading ? (
                                            <>
                                                <Icon name="RefreshCw" className="w-5 h-5 animate-spin" />
                                                Verifica in corso...
                                            </>
                                        ) : (
                                            <>
                                                <Icon name="LogIn" className="w-5 h-5" />
                                                Accedi
                                            </>
                                        )}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }
            if (error) return (
                <div className="min-h-screen bg-gradient-to-br from-indigo-600 via-purple-600 to-pink-500 flex items-center justify-center p-4">
                    <div className="bg-white p-6 rounded-lg shadow-xl text-red-600">
                        {error}
                    </div>
                </div>
            );

            if (!quizData) return (
                <div className="min-h-screen bg-gradient-to-br from-indigo-600 via-purple-600 to-pink-500 flex items-center justify-center p-4">
                    <div className="animate-pulse text-white text-xl flex items-center gap-2">
                        <Icon name="RefreshCw" className="animate-spin" />
                        Caricamento quiz...
                    </div>
                </div>
            );
            // Render principale dell'app
            return (
                <div className="min-h-screen bg-gradient-to-br from-indigo-600 via-purple-600 to-pink-500 p-4 lg:p-8">
                    <div className="max-w-2xl mx-auto bg-white rounded-2xl shadow-2xl overflow-hidden">
                        <div className="bg-white/90 p-6 border-b border-gray-100 flex justify-between items-center">
                            <img 
                                src="logo.png"
                                alt="TAM - Tassisti Artigiani Milanesi"
                                className="h-20 md:h-28"
                            />
                            <button
                                onClick={handleLogout}
                                className="text-gray-500 hover:text-red-500 transition-colors flex items-center gap-1"
                                title="Esci"
                            >
                                <span className="text-sm hidden sm:inline">Esci</span>
                                <Icon name="LogOut" className="w-5 h-5" />
                            </button>
                        </div>

                        {screen === 'home' && (
                            <div className="p-6 space-y-6">
                                <div className="text-center space-y-2">
                                    <Icon name="BookOpen" className="mx-auto text-purple-600 w-10 h-10" />
                                    <p className="text-gray-600">Seleziona una modalità di quiz</p>
                                </div>

                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                                    {/* Carta Modalità Pratica */}
                                    <div className="bg-indigo-50 border border-indigo-200 rounded-xl p-5 shadow-sm">
                                        <div className="flex items-center mb-4">
                                            <Icon name="BookOpen" className="text-indigo-600 w-6 h-6 mr-2" />
                                            <h3 className="text-lg font-bold text-indigo-800">Modalità Pratica</h3>
                                        </div>
                                        <p className="text-indigo-700 mb-4 text-sm">
                                            Esercitati su categorie specifiche di domande in base alle tue necessità.
                                        </p>
                                        <button
                                            onClick={() => setScreen('practice')}
                                            className="w-full bg-indigo-600 text-white p-3 rounded-lg 
                                                    font-semibold hover:bg-indigo-700 transition-all duration-200 flex items-center justify-center gap-2"
                                        >
                                            <Icon name="Play" className="w-4 h-4" />
                                            Inizia Pratica
                                        </button>
                                    </div>
                                    
                                    {/* Carta Modalità Esame */}
                                    <div className="bg-purple-50 border border-purple-200 rounded-xl p-5 shadow-sm">
                                        <div className="flex items-center mb-4">
                                            <Icon name="FileText" className="text-purple-600 w-6 h-6 mr-2" />
                                            <h3 className="text-lg font-bold text-purple-800">Simulazione Esame</h3>
                                        </div>
                                        <p className="text-purple-700 mb-4 text-sm">
                                            Affronta 16 domande come nel vero esame: 4 per ogni categoria principale.
                                        </p>
                                        <button
                                            onClick={() => setScreen('exam-setup')}
                                            className="w-full bg-purple-600 text-white p-3 rounded-lg 
                                                    font-semibold hover:bg-purple-700 transition-all duration-200 flex items-center justify-center gap-2"
                                        >
                                            <Icon name="FileText" className="w-4 h-4" />
                                            Inizia Simulazione
                                        </button>
                                    </div>
                                </div>
                                {screen === 'practice' && (
                            <div className="p-6 space-y-6">
                                <div className="flex items-center justify-between mb-4">
                                    <h2 className="text-xl font-bold text-gray-800">Seleziona Categorie</h2>
                                    <button
                                        onClick={() => setScreen('home')}
                                        className="text-indigo-600 hover:text-indigo-800 transition-colors flex items-center gap-1"
                                    >
                                        <Icon name="Home" className="w-5 h-5" />
                                        <span className="text-sm">Home</span>
                                    </button>
                                </div>

                                <div className="space-y-3">
                                    {/* Categorie principali */}
                                    {quizData.categorie.filter(c => typeof c === 'string').map(category => (
                                        <div 
                                            key={category} 
                                            className={`flex items-center p-4 rounded-xl transition-all duration-200 cursor-pointer
                                                ${selectedCategories.includes(category) 
                                                    ? 'bg-indigo-50 border-2 border-indigo-500' 
                                                    : 'bg-gray-50 border-2 border-transparent hover:border-indigo-300'}`}
                                            onClick={() => handleCategoryClick(category)}
                                        >
                                            <input
                                                type="checkbox"
                                                className="w-5 h-5 text-indigo-600 rounded"
                                                checked={selectedCategories.includes(category)}
                                                onChange={() => {}}
                                            />
                                            <label className="ml-3 text-black font-bold flex-1 cursor-pointer">
                                                {category}
                                            </label>
                                        </div>
                                    ))}
                                    
                                    {/* Categorie con sottocategorie */}
                                    {quizData.categorie.filter(c => typeof c === 'object' && c.nome && c.sottocategorie).map(category => {
                                        const isExpanded = expandedCategories.includes(category.nome);
                                        
                                        return (
                                            <div key={category.nome} className="space-y-2">
                                                <div 
                                                    className="flex items-center p-4 rounded-xl transition-all duration-200 cursor-pointer
                                                        bg-gray-50 border-2 border-transparent hover:border-indigo-300"
                                                    onClick={() => toggleCategory(category.nome)}
                                                >
                                                    <div className="flex items-center justify-between w-full">
                                                        <div className="flex items-center">
                                                            <Icon name="Globe" className="w-5 h-5 text-red-500 mr-3" />
                                                            <label className="text-red-600 font-bold cursor-pointer">
                                                                {category.nome}
                                                            </label>
                                                        </div>
                                                        <Icon name={isExpanded ? "ChevronUp" : "ChevronDown"} className="w-5 h-5 text-red-500" />
                                                    </div>
                                                </div>
                                                
                                                {isExpanded && (
                                                    <div className="ml-6 space-y-2 pl-4 border-l-2 border-red-200">
                                                        {category.sottocategorie.map(subCategory => (
                                                            <div 
                                                                key={subCategory}
                                                                className={`flex items-center p-3 rounded-lg transition-all duration-200 cursor-pointer
                                                                ${selectedCategories.includes(subCategory) 
                                                                    ? 'bg-red-50 border-2 border-red-500' 
                                                                    : 'bg-gray-50 border-2 border-transparent hover:border-red-300'}`}
                                                                onClick={() => handleCategoryClick(subCategory)}
                                                            >
                                                                <input
                                                                    type="checkbox"
                                                                    className="w-4 h-4 text-red-600 rounded"
                                                                    checked={selectedCategories.includes(subCategory)}
                                                                    onChange={() => {}}
                                                                />
                                                                <label className="ml-3 text-red-600 font-bold cursor-pointer">
                                                                    {subCategory}
                                                                </label>
                                                            </div>
                                                        ))}
                                                    </div>
                                                )}
                                            </div>
                                        );
                                    })}
                                </div>

                                <button
                                    onClick={startQuiz}
                                    disabled={selectedCategories.length === 0}
                                    className={`w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white p-4 rounded-xl 
                                            font-semibold transition-all duration-200 flex items-center justify-center gap-2
                                            ${selectedCategories.length === 0 ? 'opacity-50 cursor-not-allowed' : 'hover:opacity-90'}`}
                                >
                                    <Icon name="Play" className="w-5 h-5" />
                                    Inizia Quiz
                                </button>
                            </div>
                        )}
                        {screen === 'exam-setup' && (
                            <div className="p-6 space-y-6">
                                <div className="flex items-center justify-between mb-4">
                                    <h2 className="text-xl font-bold text-gray-800">Configurazione Esame</h2>
                                    <button
                                        onClick={() => setScreen('home')}
                                        className="text-indigo-600 hover:text-indigo-800 transition-colors flex items-center gap-1"
                                    >
                                        <Icon name="Home" className="w-5 h-5" />
                                        <span className="text-sm">Home</span>
                                    </button>
                                </div>
                                
                                <div className="bg-purple-50 rounded-xl p-5 border border-purple-200">
                                    <h3 className="text-purple-800 font-bold mb-3 flex items-center">
                                        <Icon name="FileText" className="w-5 h-5 mr-2 text-purple-600" />
                                        Informazioni esame
                                    </h3>
                                    <ul className="space-y-2 text-purple-700 text-sm">
                                        <li className="flex items-start">
                                            <div className="min-w-4 min-h-4 rounded-full bg-purple-600 mt-1.5 mr-2"></div>
                                            <span>Verranno selezionate automaticamente 16 domande: 4 per Geografia, 4 per Normativa, 4 per Regolamento e 4 per la lingua scelta</span>
                                        </li>
                                        <li className="flex items-start">
                                            <div className="min-w-4 min-h-4 rounded-full bg-purple-600 mt-1.5 mr-2"></div>
                                            <span>Per superare l'esame è consentito un massimo di 4 errori totali</span>
                                        </li>
                                        <li className="flex items-start">
                                            <div className="min-w-4 min-h-4 rounded-full bg-purple-600 mt-1.5 mr-2"></div>
                                            <span>Non più di 2 errori per ogni categoria</span>
                                        </li>
                                    </ul>
                                </div>
                                
                                <div className="bg-indigo-50 rounded-xl p-5 border border-indigo-200">
                                    <h3 className="text-indigo-800 font-bold mb-3 flex items-center">
                                        <Icon name="Globe" className="w-5 h-5 mr-2 text-indigo-600" />
                                        Seleziona la lingua
                                    </h3>
                                    <div className="grid grid-cols-2 gap-3">
                                        {quizData.categorie.find(c => typeof c === 'object' && c.nome === 'Lingue')?.sottocategorie.map(language => (
                                            <button
                                                key={language}
                                                onClick={() => setSelectedLanguage(language)}
                                                className={`p-3 rounded-lg border-2 transition-all font-medium
                                                    ${selectedLanguage === language
                                                    ? 'bg-indigo-100 border-indigo-500 text-indigo-700'
                                                    : 'bg-white border-gray-200 text-gray-700 hover:border-indigo-300'}`}
                                            >
                                                {language}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                                
                                <button
                                    onClick={startExam}
                                    className="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white p-4 rounded-xl 
                                            font-semibold hover:opacity-90 transition-all duration-200 flex items-center justify-center gap-2"
                                >
                                    <Icon name="FileText" className="w-5 h-5" />
                                    Inizia Simulazione Esame
                                </button>
                            </div>
                        )}
                        {screen === 'quiz' && selectedQuestions.length > 0 && (
                            <div className="p-6">
                                <div className="mb-6">
                                    <div className="flex justify-between items-center mb-2">
                                        <span className="text-sm text-gray-600">
                                            Domanda {currentQuestion + 1} di {selectedQuestions.length}
                                        </span>
                                        
                                        {examMode && (
                                            <div className="flex items-center text-purple-600 font-medium">
                                                <Icon name="Clock" className="w-4 h-4 mr-1" />
                                                <span>{formatTime(examTime)}</span>
                                            </div>
                                        )}
                                        
                                        <button
                                            onClick={() => {
                                                if (examMode) {
                                                    if (confirm("Sei sicuro di voler interrompere l'esame? I progressi andranno persi.")) {
                                                        setExamTimerRunning(false);
                                                        setScreen('home');
                                                    }
                                                } else {
                                                    setScreen('home');
                                                }
                                            }}
                                            className="bg-white hover:bg-indigo-50 border-2 border-indigo-200 hover:border-indigo-300 
                                            text-indigo-600 px-3 py-1.5 rounded-lg transition-all duration-200 
                                            flex items-center gap-1 shadow-sm text-sm"
                                        >
                                            <Icon name="Home" className="w-4 h-4" />
                                            <span>Home</span>
                                        </button>
                                    </div>
                                    
                                    <div className="h-2 bg-gray-200 rounded-full overflow-hidden">
                                        <div 
                                            className="h-full bg-gradient-to-r from-indigo-600 to-purple-600 transition-all duration-500" 
                                            style={{ width: `${((currentQuestion + 1) / selectedQuestions.length) * 100}%` }}
                                        />
                                    </div>
                                </div>
                                
                                <div className="inline-block bg-gradient-to-r from-indigo-100 to-purple-100 
                                            text-indigo-800 px-4 py-2 rounded-full text-sm font-medium mb-4">
                                    {selectedQuestions[currentQuestion].categoria}
                                </div>
                                
                                <div className="text-lg text-gray-800 mb-6 font-medium">
                                    {selectedQuestions[currentQuestion].testo}
                                </div>

                                <div className="space-y-3">
                                    {selectedQuestions[currentQuestion].opzioni.map((option, index) => {
                                        const isCorrect = index === selectedQuestions[currentQuestion].risposta_corretta;
                                        const isSelected = selectedAnswer === index;
                                        let buttonStyle = "bg-white border-2 hover:border-indigo-300";
                                        
                                        if (answerGiven) {
                                            if (isCorrect) {
                                                buttonStyle = "bg-green-50 border-2 border-green-500";
                                            } else if (isSelected) {
                                                buttonStyle = "bg-red-50 border-2 border-red-500";
                                            }
                                        }

                                        return (
                                            <button
                                                key={index}
                                                onClick={() => checkAnswer(index)}
                                                className={`w-full p-4 rounded-xl text-left transition-all duration-200 
                                                        flex items-center justify-between group ${buttonStyle}`}
                                                disabled={answerGiven}
                                            >
                                                <span className="flex-1">{option}</span>
                                                {answerGiven && (isCorrect ? 
                                                    <Icon name="CheckCircle" className="text-green-500 w-5 h-5" /> : 
                                                    (isSelected && <Icon name="XCircle" className="text-red-500 w-5 h-5" />)
                                                )}
                                            </button>
                                        );
                                    })}
                                </div>

                                {answerGiven && (
                                    <button
                                        onClick={nextQuestion}
                                        className="w-full mt-6 bg-gradient-to-r from-indigo-600 to-purple-600 
                                                text-white p-4 rounded-xl font-semibold hover:opacity-90 
                                                transition-all duration-200 flex items-center justify-center gap-2"
                                    >
                                        {currentQuestion < selectedQuestions.length - 1 ? (
                                            <>
                                                Prossima
                                                <Icon name="ArrowRight" className="w-5 h-5" />
                                            </>
                                        ) : (
                                            <>
                                                Vedi Risultati
                                                <Icon name="Award" className="w-5 h-5" />
                                            </>
                                        )}
                                    </button>
                                )}
                            </div>
                        )}
                        {screen === 'results' && (
                            <div className="p-6 text-center space-y-6">
                                {examMode && examResults ? (
                                    // Risultati modalità Esame
                                    <div className="space-y-6">
                                        <div className={`text-center mx-auto rounded-full w-20 h-20 flex items-center justify-center ${examResults.passed ? 'bg-green-100' : 'bg-red-100'}`}>
                                            <Icon 
                                                name={examResults.passed ? "CheckCircle" : "AlertTriangle"} 
                                                className={`w-12 h-12 ${examResults.passed ? 'text-green-500' : 'text-red-500'}`} 
                                            />
                                        </div>
                                        
                                        <div>
                                            <h2 className={`text-2xl font-bold mb-2 ${examResults.passed ? 'text-green-600' : 'text-red-600'}`}>
                                                {examResults.passed ? 'Esame Superato!' : 'Esame Non Superato'}
                                            </h2>
                                            <p className="text-gray-600 mb-4">
                                                Hai completato l'esame in {formatTime(examResults.time)}
                                            </p>
                                            <div className="text-lg text-gray-700">
                                                {examResults.totalErrors} errori su {selectedQuestions.length} domande
                                            </div>
                                        </div>
                                        
                                        <div className="bg-gray-50 p-4 rounded-lg border border-gray-200">
                                            <h3 className="font-bold text-gray-700 mb-2 text-left">Dettaglio errori per categoria:</h3>
                                            <div className="space-y-2">
                                                {Object.entries(examResults.errorsByCategory).map(([category, errors]) => (
                                                    <div 
                                                        key={category} 
                                                        className="flex justify-between items-center p-2 border-b border-gray-200 last:border-0"
                                                    >
                                                        <span className="font-medium">{category}:</span>
                                                        <span className={`font-bold ${errors > 2 ? 'text-red-500' : 'text-gray-700'}`}>
                                                            {errors} errori
                                                        </span>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                        
                                        {!examResults.passed && (
                                            <div className="bg-amber-50 p-4 rounded-lg border border-amber-200 text-amber-800 text-sm text-left">
                                                <div className="font-bold flex items-center mb-1">
                                                    <Icon name="AlertTriangle" className="w-4 h-4 mr-1" />
                                                    Motivo del non superamento:
                                                </div>
                                                {examResults.totalErrors > 4 ? (
                                                    <p>Hai superato il limite massimo di 4 errori totali.</p>
                                                ) : (
                                                    <p>Hai commesso più di 2 errori in almeno una categoria.</p>
                                                )}
                                            </div>
                                        )}
                                        
                                        <div className="flex flex-col space-y-3">
                                            <button
                                                onClick={() => startExam()}
                                                className="w-full bg-gradient-to-r from-indigo-600 to-purple-600 
                                                        text-white p-4 rounded-xl font-semibold hover:opacity-90 
                                                        transition-all duration-200 flex items-center justify-center gap-2"
                                            >
                                                <Icon name="RefreshCw" className="w-5 h-5" />
                                                Nuovo Esame
                                            </button>
                                            
                                            <button
                                                onClick={() => setScreen('home')}
                                                className="w-full bg-gray-100 text-gray-700 p-4 rounded-xl 
                                                        font-semibold hover:bg-gray-200 
                                                        transition-all duration-200 flex items-center justify-center gap-2"
                                            >
                                                <Icon name="Home" className="w-5 h-5" />
                                                Torna alla Home
                                            </button>
                                        </div>
                                    </div>
                                ) : (
                                    // Risultati modalità Pratica
                                    <div className="space-y-6">
                                        <Icon name="Award" className="mx-auto text-indigo-600 w-20 h-20" />
                                        
                                        <div>
                                            <div className="text-6xl font-bold bg-gradient-to-r from-indigo-600 to-purple-600 
                                                        bg-clip-text text-transparent mb-2">
                                                {Math.round((score / selectedQuestions.length) * 100)}%
                                            </div>
                                            <div className="text-xl text-gray-600">
                                                {score} risposte corrette su {selectedQuestions.length}
                                            </div>
                                        </div>
                                        
                                        {!reviewMode && wrongQuestions.length > 0 && (
                                            <button
                                                onClick={startReview}
                                                className="w-full bg-gradient-to-r from-orange-500 to-red-500 
                                                        text-white p-4 rounded-xl font-semibold hover:opacity-90 
                                                        transition-all duration-200 flex items-center justify-center gap-2"
                                            >
                                                <Icon name="RefreshCw" className="w-5 h-5" />
                                                Ripassa {wrongQuestions.length} domande sbagliate
                                            </button>
                                        )}
                                        
                                        <button
                                            onClick={() => setScreen('home')}
                                            className="w-full bg-gradient-to-r from-indigo-600 to-purple-600 
                                                    text-white p-4 rounded-xl font-semibold hover:opacity-90 
                                                    transition-all duration-200 flex items-center justify-center gap-2"
                                        >
                                            <Icon name="Home" className="w-5 h-5" />
                                            Torna alla Home
                                        </button>
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<QuizApp />);
    </script>
</body>
</html>