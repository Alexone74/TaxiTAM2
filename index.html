<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Quiz Esame al Ruolo Conducenti</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            font-size: 16px;
        }
        @media (max-width: 640px) {
            html {
                font-size: 14px;
            }
        }
        button {
            touch-action: manipulation;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        const icons = lucide.createIcons({
            icons: {
                BookOpen: lucide.icons.BookOpen,
                Home: lucide.icons.Home,
                Award: lucide.icons.Award,
                ArrowRight: lucide.icons.ArrowRight,
                Play: lucide.icons.Play,
                RefreshCw: lucide.icons.RefreshCw,
                CheckCircle: lucide.icons.CheckCircle,
                XCircle: lucide.icons.XCircle,
                LogIn: lucide.icons.LogIn,
                Lock: lucide.icons.Lock,
                LogOut: lucide.icons.LogOut,
                ChevronDown: lucide.icons.ChevronDown,
                ChevronUp: lucide.icons.ChevronUp,
                Globe: lucide.icons.Globe
            }
        });

        function Icon({ name, ...props }) {
            return <i data-lucide={name} {...props}></i>;
        }

        function QuizApp() {
            const [screen, setScreen] = useState('login');
            const [quizData, setQuizData] = useState(null);
            const [accessCodes, setAccessCodes] = useState(null);
            const [error, setError] = useState(null);
            const [selectedQuestions, setSelectedQuestions] = useState([]);
            const [currentQuestion, setCurrentQuestion] = useState(0);
            const [score, setScore] = useState(0);
            const [answerGiven, setAnswerGiven] = useState(false);
            const [wrongQuestions, setWrongQuestions] = useState([]);
            const [reviewMode, setReviewMode] = useState(false);
            const [selectedCategories, setSelectedCategories] = useState([]);
            const [selectedAnswer, setSelectedAnswer] = useState(null);
            const [accessCode, setAccessCode] = useState('');
            const [loginError, setLoginError] = useState('');
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [isLoading, setIsLoading] = useState(false);
            const [expandedCategory, setExpandedCategory] = useState(null);
            
            // Funzione per creare hash SHA-256
            const hashCode = (code) => {
                return CryptoJS.SHA256(code).toString();
            };
            
            // Verifica se un utente è già autenticato
            useEffect(() => {
                const savedAuth = localStorage.getItem('quiz_authenticated');
                if (savedAuth === 'true') {
                    setIsAuthenticated(true);
                    setScreen('home');
                }
            }, []);

            // Carica i dati del quiz
            useEffect(() => {
                if (isAuthenticated) {
                    fetch('quiz.json')
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Network response was not ok');
                            }
                            return response.json();
                        })
                        .then(data => {
                            setQuizData(data);
                            setError(null);
                        })
                        .catch(error => {
                            console.error('Error loading quiz:', error);
                            setError('Errore nel caricamento del quiz. Riprova più tardi.');
                        });
                }
            }, [isAuthenticated]);

            // Carica i codici di accesso
            useEffect(() => {
                fetch('access-codes.json')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {
                        setAccessCodes(data);
                    })
                    .catch(error => {
                        console.error('Error loading access codes:', error);
                        setLoginError('Errore nel caricamento dei codici di accesso. Riprova più tardi.');
                    });
            }, []);

            const handleLogin = () => {
                if (!accessCodes) {
                    setLoginError('Errore nel caricamento dei codici di accesso. Riprova più tardi.');
                    return;
                }

                setIsLoading(true);
                
                // Calcoliamo l'hash del codice inserito
                const hashedInput = hashCode(accessCode);
                
                // Verifichiamo se l'hash corrisponde a uno dei codici salvati
                if (accessCodes.codes.includes(hashedInput)) {
                    setIsAuthenticated(true);
                    localStorage.setItem('quiz_authenticated', 'true');
                    setScreen('home');
                    setLoginError('');
                } else {
                    setLoginError('Codice di accesso non valido');
                }
                
                setIsLoading(false);
            };

            const handleLogout = () => {
                setIsAuthenticated(false);
                localStorage.removeItem('quiz_authenticated');
                setScreen('login');
                setAccessCode('');
            };

            const toggleCategory = (categoryName) => {
                if (expandedCategory === categoryName) {
                    setExpandedCategory(null);
                } else {
                    setExpandedCategory(categoryName);
                }
            };

            const startQuiz = () => {
                if (selectedCategories.length === 0) {
                    alert('Seleziona almeno una categoria!');
                    return;
                }

                // Raccogliamo tutte le categorie selezionate, includendo le sottocategorie
                let allSelectedCategories = [...selectedCategories];
                
                // Controlliamo se 'Lingue' è selezionata e aggiungiamo tutte le sue sottocategorie
                quizData.categorie.forEach(categoria => {
                    if (typeof categoria === 'object' && categoria.nome === 'Lingue' && selectedCategories.includes('Lingue')) {
                        allSelectedCategories = allSelectedCategories.concat(categoria.sottocategorie);
                    }
                });
                
                // Rimuoviamo 'Lingue' perché non è una categoria reale di domande
                allSelectedCategories = allSelectedCategories.filter(cat => cat !== 'Lingue');

                const filteredQuestions = quizData.domande
                    .filter(q => allSelectedCategories.includes(q.categoria))
                    .sort(() => Math.random() - 0.5);

                setSelectedQuestions(filteredQuestions);
                setCurrentQuestion(0);
                setScore(0);
                setWrongQuestions([]);
                setReviewMode(false);
                setScreen('quiz');
                setSelectedAnswer(null);
                setAnswerGiven(false);
            };

            const checkAnswer = (selectedIndex) => {
                if (answerGiven) return;

                setAnswerGiven(true);
                setSelectedAnswer(selectedIndex);
                const currentQ = selectedQuestions[currentQuestion];

                if (selectedIndex === currentQ.risposta_corretta) {
                    setScore(prev => prev + 1);
                } else if (!reviewMode) {
                    setWrongQuestions(prev => [...prev, currentQ]);
                }
            };

            const nextQuestion = () => {
                if (currentQuestion < selectedQuestions.length - 1) {
                    setCurrentQuestion(prev => prev + 1);
                    setAnswerGiven(false);
                    setSelectedAnswer(null);
                } else {
                    setScreen('results');
                }
            };

            const startReview = () => {
                setSelectedQuestions(wrongQuestions);
                setCurrentQuestion(0);
                setScore(0);
                setWrongQuestions([]);
                setReviewMode(true);
                setScreen('quiz');
                setAnswerGiven(false);
                setSelectedAnswer(null);
            };

            // Gestione del tasto Enter per il login
            const handleKeyPress = (e) => {
                if (e.key === 'Enter') {
                    handleLogin();
                }
            };

            // Schermata di login
            if (screen === 'login') {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-indigo-600 via-purple-600 to-pink-500 flex items-center justify-center p-4">
                        <div className="max-w-md w-full bg-white rounded-2xl shadow-2xl overflow-hidden">
                            <div className="bg-white/90 p-6 border-b border-gray-100 flex justify-center">
                                <img 
                                    src="logo.png"
                                    alt="TAM - Tassisti Artigiani Milanesi"
                                    className="h-20 md:h-28"
                                />
                            </div>
                            
                            <div className="p-6 space-y-6">
                                <div className="text-center space-y-2">
                                    <Icon name="Lock" className="mx-auto text-purple-600 w-12 h-12" />
                                    <h2 className="text-2xl font-bold text-gray-800">Accesso al Quiz</h2>
                                    <p className="text-gray-600">Inserisci il tuo codice di accesso</p>
                                </div>
                                
                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">
                                            Codice di accesso
                                        </label>
                                        <input
                                            type="text"
                                            value={accessCode}
                                            onChange={(e) => setAccessCode(e.target.value)}
                                            onKeyPress={handleKeyPress}
                                            placeholder="Inserisci il codice di 8 caratteri"
                                            className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-all"
                                            maxLength={15}
                                        />
                                    </div>
                                    
                                    {loginError && (
                                        <div className="text-red-500 text-sm font-medium">{loginError}</div>
                                    )}
                                    
                                    <button
                                        onClick={handleLogin}
                                        disabled={isLoading || accessCode.length < 3}
                                        className={`w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white p-4 rounded-xl 
                                                font-semibold transition-all duration-200 flex items-center justify-center gap-2
                                                ${(isLoading || accessCode.length < 3) ? 'opacity-70 cursor-not-allowed' : 'hover:opacity-90'}`}
                                    >
                                        {isLoading ? (
                                            <>
                                                <Icon name="RefreshCw" className="w-5 h-5 animate-spin" />
                                                Verifica in corso...
                                            </>
                                        ) : (
                                            <>
                                                <Icon name="LogIn" className="w-5 h-5" />
                                                Accedi
                                            </>
                                        )}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            if (error) return (
                <div className="min-h-screen bg-gradient-to-br from-indigo-600 via-purple-600 to-pink-500 flex items-center justify-center p-4">
                    <div className="bg-white p-6 rounded-lg shadow-xl text-red-600">
                        {error}
                    </div>
                </div>
            );

            if (!quizData) return (
                <div className="min-h-screen bg-gradient-to-br from-indigo-600 via-purple-600 to-pink-500 flex items-center justify-center p-4">
                    <div className="animate-pulse text-white text-xl flex items-center gap-2">
                        <Icon name="RefreshCw" className="animate-spin" />
                        Caricamento quiz...
                    </div>
                </div>
            );

            return (
                <div className="min-h-screen bg-gradient-to-br from-indigo-600 via-purple-600 to-pink-500 p-4 lg:p-8">
                    <div className="max-w-2xl mx-auto bg-white rounded-2xl shadow-2xl overflow-hidden">
                        <div className="bg-white/90 p-6 border-b border-gray-100 flex justify-between items-center">
                            <img 
                                src="logo.png"
                                alt="TAM - Tassisti Artigiani Milanesi"
                                className="h-20 md:h-28"
                            />
                            <button
                                onClick={handleLogout}
                                className="text-gray-500 hover:text-red-500 transition-colors flex items-center gap-1"
                                title="Esci"
                            >
                                <span className="text-sm hidden sm:inline">Esci</span>
                                <Icon name="LogOut" className="w-5 h-5" />
                            </button>
                        </div>

                        {screen === 'home' && (
                            <div className="p-6 space-y-6">
                                <div className="text-center space-y-2">
                                    <Icon name="BookOpen" className="mx-auto text-purple-600 w-10 h-10" />
                                    <p className="text-gray-600">Seleziona le categorie e inizia il test</p>
                                </div>

                                <div className="space-y-3">
                                    {quizData.categorie.map((category, index) => {
                                        // Se è una categoria semplice (stringa)
                                        if (typeof category === 'string') {
                                            return (
                                                <div 
                                                    key={category} 
                                                    className={`flex items-center p-4 rounded-xl transition-all duration-200 cursor-pointer
                                                        ${selectedCategories.includes(category) 
                                                            ? 'bg-indigo-50 border-2 border-indigo-500' 
                                                            : 'bg-gray-50 border-2 border-transparent hover:border-indigo-300'}`}
                                                    onClick={() => {
                                                        setSelectedCategories(prev =>
                                                            prev.includes(category)
                                                                ? prev.filter(c => c !== category)
                                                                : [...prev, category]
                                                        );
                                                    }}
                                                >
                                                    <input
                                                        type="checkbox"
                                                        className="w-5 h-5 text-indigo-600 rounded"
                                                        checked={selectedCategories.includes(category)}
                                                        onChange={() => {}}
                                                    />
                                                    <label className="ml-3 text-gray-700 font-medium flex-1 cursor-pointer">
                                                        {category}
                                                    </label>
                                                </div>
                                            );
                                        } 
                                        // Se è una categoria con sottocategorie (oggetto)
                                        else if (category.nome && category.sottocategorie) {
                                            const isExpanded = expandedCategory === category.nome;
                                            const isSelected = selectedCategories.includes(category.nome);
                                            
                                            return (
                                                <div key={category.nome} className="space-y-2">
                                                    <div 
                                                        className={`flex items-center p-4 rounded-xl transition-all duration-200 cursor-pointer
                                                            ${isSelected
                                                                ? 'bg-indigo-50 border-2 border-indigo-500' 
                                                                : 'bg-gray-50 border-2 border-transparent hover:border-indigo-300'}`}
                                                        onClick={() => {
                                                            setSelectedCategories(prev => {
                                                                // Se già selezionata, rimuovila
                                                                if (prev.includes(category.nome)) {
                                                                    return prev.filter(c => c !== category.nome);
                                                                } 
                                                                // Altrimenti aggiungila
                                                                else {
                                                                    return [...prev, category.nome];
                                                                }
                                                            });
                                                        }}
                                                    >
                                                        <input
                                                            type="checkbox"
                                                            className="w-5 h-5 text-indigo-600 rounded"
                                                            checked={isSelected}
                                                            onChange={() => {}}
                                                        />
                                                        <div className="ml-3 flex-1 flex items-center justify-between">
                                                            <label className="text-gray-700 font-medium cursor-pointer flex items-center gap-2">
                                                                <Icon name="Globe" className="w-5 h-5 text-indigo-500" />
                                                                {category.nome}
                                                            </label>
                                                            <button 
                                                                onClick={(e) => {
                                                                    e.stopPropagation();
                                                                    toggleCategory(category.nome);
                                                                }}
                                                                className="text-gray-500 hover:bg-indigo-100 rounded-full p-1"
                                                            >
                                                                <Icon name={isExpanded ? "ChevronUp" : "ChevronDown"} className="w-5 h-5" />
                                                            </button>
                                                        </div>
                                                    </div>
                                                    
                                                    {isExpanded && (
                                                        <div className="ml-6 space-y-2 pl-4 border-l-2 border-indigo-200">
                                                            {category.sottocategorie.map(subCategory => (
                                                                <div 
                                                                    key={subCategory}
                                                                    className="p-3 bg-gray-50 rounded-lg text-sm flex items-center"
                                                                >
                                                                    <span className="flex-1 font-medium text-gray-700">{subCategory}</span>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    )}
                                                </div>
                                            );
                                        }
                                        return null;
                                    })}
                                </div>

                                <button
                                    onClick={startQuiz}
                                    className="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white p-4 rounded-xl 
                                            font-semibold hover:opacity-90 transition-all duration-200 flex items-center justify-center gap-2"
                                >
                                    <Icon name="Play" className="w-5 h-5" />
                                    Inizia Quiz
                                </button>
                            </div>
                        )}

                        {screen === 'quiz' && selectedQuestions.length > 0 && (
                            <div className="p-6">
                                <div className="mb-6">
                                    <div className="h-2 bg-gray-200 rounded-full overflow-hidden">
                                        <div 
                                            className="h-full bg-gradient-to-r from-indigo-600 to-purple-600 transition-all duration-500" 
                                            style={{ width: `${((currentQuestion + 1) / selectedQuestions.length) * 100}%` }}
                                        />
                                    </div>
                                    <div className="flex justify-between items-center mt-2">
                                        <span className="text-sm text-gray-600">
                                            Domanda {currentQuestion + 1} di {selectedQuestions.length}
                                        </span>
                                        <button
                                            onClick={() => setScreen('home')}
                                            className="bg-white hover:bg-indigo-50 border-2 border-indigo-200 hover:border-indigo-300 
                                            text-indigo-600 px-4 py-2 rounded-lg transition-all duration-200 
                                            flex items-center gap-2 shadow-sm"
                                        >
                                            <Icon name="Home" className="w-4 h-4" />
                                            <span className="font-medium">Home</span>
                                        </button>
                                    </div>
                                </div>
                                
                                <div className="inline-block bg-gradient-to-r from-indigo-100 to-purple-100 
                                            text-indigo-800 px-4 py-2 rounded-full text-sm font-medium mb-4">
                                    {selectedQuestions[currentQuestion].categoria}
                                </div>
                                
                                <div className="text-lg text-gray-800 mb-6 font-medium">
                                    {selectedQuestions[currentQuestion].testo}
                                </div>

                                <div className="space-y-3">
                                    {selectedQuestions[currentQuestion].opzioni.map((option, index) => {
                                        const isCorrect = index === selectedQuestions[currentQuestion].risposta_corretta;
                                        const isSelected = selectedAnswer === index;
                                        let buttonStyle = "bg-white border-2 hover:border-indigo-300";
                                        
                                        if (answerGiven) {
                                            if (isCorrect) {
                                                buttonStyle = "bg-green-50 border-2 border-green-500";
                                            } else if (isSelected) {
                                                buttonStyle = "bg-red-50 border-2 border-red-500";
                                            }
                                        }

                                        return (
                                            <button
                                                key={index}
                                                onClick={() => checkAnswer(index)}
                                                className={`w-full p-4 rounded-xl text-left transition-all duration-200 
                                                        flex items-center justify-between group ${buttonStyle}`}
                                                disabled={answerGiven}
                                            >
                                                <span className="flex-1">{option}</span>
                                                {answerGiven && (isCorrect ? 
                                                    <Icon name="CheckCircle" className="text-green-500 w-5 h-5" /> : 
                                                    (isSelected && <Icon name="XCircle" className="text-red-500 w-5 h-5" />)
                                                )}
                                            </button>
                                        );
                                    })}
                                </div>

                                {answerGiven && (
                                    <button
                                        onClick={nextQuestion}
                                        className="w-full mt-6 bg-gradient-to-r from-indigo-600 to-purple-600 
                                                text-white p-4 rounded-xl font-semibold hover:opacity-90 
                                                transition-all duration-200 flex items-center justify-center gap-2"
                                    >
                                        {currentQuestion < selectedQuestions.length - 1 ? (
                                            <>
                                                Prossima
                                                <Icon name="ArrowRight" className="w-5 h-5" />
                                            </>
                                        ) : (
                                            <>
                                                Vedi Risultati
                                                <Icon name="Award" className="w-5 h-5" />
                                            </>
                                        )}
                                    </button>
                                )}
                            </div>
                        )}

                        {screen === 'results' && (
                            <div className="p-6 text-center space-y-6">
                                <Icon name="Award" className="mx-auto text-indigo-600 w-20 h-20" />
                                
                                <div>
                                    <div className="text-6xl font-bold bg-gradient-to-r from-indigo-600 to-purple-600 
                                                bg-clip-text text-transparent mb-2">
                                        {Math.round((score / selectedQuestions.length) * 100)}%
                                    </div>
                                    <div className="text-xl text-gray-600">
                                        {score} risposte corrette su {selectedQuestions.length}
                                    </div>
                                </div>
                                
                                {!reviewMode && wrongQuestions.length > 0 && (
                                    <button
                                        onClick={startReview}
                                        className="w-full bg-gradient-to-r from-orange-500 to-red-500 
                                                text-white p-4 rounded-xl font-semibold hover:opacity-90 
                                                transition-all duration-200 flex items-center justify-center gap-2"
                                    >
                                        <Icon name="RefreshCw" className="w-5 h-5" />
                                        Ripassa {wrongQuestions.length} domande sbagliate
                                    </button>
                                )}
                                
                                <button
                                    onClick={() => setScreen('home')}
                                    className="w-full bg-gradient-to-r from-indigo-600 to-purple-600 
                                            text-white p-4 rounded-xl font-semibold hover:opacity-90 
                                            transition-all duration-200 flex items-center justify-center gap-2"
                                >
                                    <Icon name="Home" className="w-5 h-5" />
                                    Torna alla Home
                                </button>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<QuizApp />);
    </script>
</body>
</html>